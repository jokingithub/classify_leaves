class LeafCategory(DB.Model):
    id = DB.Column(DB.Integer, primary_key=True)
    category_name = DB.Column(DB.String(50), unique=True, nullable=False)
    chinese_name = DB.Column(DB.String(50), nullable=False)
    description = DB.Column(DB.Text, nullable=False)

class Feedback(DB.Model):
    id = DB.Column(DB.Integer, primary_key=True)
    name = DB.Column(DB.String(50), nullable=False)
    email = DB.Column(DB.String(120), nullable=False)
    message = DB.Column(DB.Text, nullable=False)
    reg_date = DB.Column(DB.DateTime, default=DB.func.current_timestamp())

@app.route('/admin', methods=['GET', 'POST'])
def admin():
    if request.method == 'POST':
        action = request.form['action']
        if action == 'add_category':
            category_name = request.form['category_name']
            chinese_name = request.form['chinese_name']
            description = request.form['description']
            new_category = LeafCategory(
                category_name=category_name,
                chinese_name=chinese_name,
                description=description
            )
            DB.session.add(new_category)
            DB.session.commit()
        elif action == 'delete_category':
            category_id = request.form['category_id']
            category = LeafCategory.query.get(category_id)
            if category:
                DB.session.delete(category)
                DB.session.commit()
        elif action == 'export_feedback':
            export_feedback_to_csv()

    categories = LeafCategory.query.all()
    feedbacks = Feedback.query.all()
    return render_template('admin.html', categories=categories, feedbacks=feedbacks)

def export_feedback_to_csv():
    with app.app_context():
        export_path = './instance/feedback.csv'
        feedbacks = Feedback.query.all()
        with open(export_path, 'w', newline='') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(['ID', 'Name', 'Email', 'Message', 'Date'])
            for feedback in feedbacks:
                writer.writerow([feedback.id, feedback.name, feedback.email, feedback.message, feedback.reg_date])